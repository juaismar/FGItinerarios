<!-- Estaciones Content -->
<style>
    .estacion-activa {
        color: #28a745;
    }
    .estacion-inactiva {
        color: #dc3545;
    }
    .btn-icon {
        padding: 0.25rem 0.5rem;
        margin: 0 0.2rem;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    .btn-icon:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn-editar {
        background-color: #1976d2;
        color: white;
    }
    .btn-editar:hover {
        background-color: #1565c0;
        color: white;
    }
    .btn-eliminar {
        background-color: #dc3545;
        color: white;
    }
    .btn-eliminar:hover {
        background-color: #c82333;
        color: white;
    }
    .acciones-cell {
        white-space: nowrap;
        text-align: center;
    }
    [data-bs-toggle="tooltip"] {
        cursor: pointer;
    }
    
    /* Estilo para el botón de cierre del modal */
    .btn-close-custom {
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        padding: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
    }
    
    .btn-close-custom:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }
    
    .btn-close-custom .fas {
        color: white;
        font-size: 1rem;
    }
    

    
    /* Estilos para las alertas de notificación */
    .alert {
        border-radius: 8px;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .alert-heading {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 8px;
    }
    
    .alert-success {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
        border-left: 4px solid #28a745;
    }
    
    .alert-danger {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        color: #721c24;
        border-left: 4px solid #dc3545;
    }
    
    .alert-warning {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        color: #856404;
        border-left: 4px solid #ffc107;
    }
    
    .alert-info {
        background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        color: #0c5460;
        border-left: 4px solid #17a2b8;
    }
    
    /* Animación para las alertas */
    .alert.fade.show {
        animation: slideInDown 0.5s ease-out;
    }
    
    @keyframes slideInDown {
        from {
            transform: translateY(-100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>

<div id="estaciones-content">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Gestión de Estaciones</h3>
      <div class="card-tools">
        <button type="button" class="btn btn-primary btn-sm nueva-estacion">
          <i class="fas fa-plus"></i> Nueva Estación
        </button>
      </div>
    </div>
    <div class="card-body">
      <table id="tablaEstaciones" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Código</th>
            <th>Ubicación</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
            <!-- Se llenará dinámicamente -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal AdminLTE para Crear/Editar Estación -->
<div class="modal fade" id="estacionModal" tabindex="-1" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title" id="modalTitle">
                    <i class="fas fa-train"></i> Nueva Estación
                </h5>
                <button type="button" class="btn-close-custom" id="btnCerrarModal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="estacionForm">
                    <input type="hidden" id="estacionId">
                    
                    <div class="form-group">
                        <label for="nombre" class="form-label">
                            <i class="fas fa-tag"></i> Nombre
                        </label>
                        <input type="text" class="form-control" id="nombre" placeholder="Introduce el nombre de la estación" required>
                        <div class="invalid-feedback">
                            Por favor introduce un nombre válido.
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="codigo" class="form-label">
                            <i class="fas fa-code"></i> Código
                        </label>
                        <input type="text" class="form-control" id="codigo" placeholder="Código de 3 caracteres" required maxlength="3">
                        <div class="invalid-feedback">
                            El código debe tener 3 caracteres.
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ubicacion" class="form-label">
                            <i class="fas fa-map-marker-alt"></i> Ubicación
                        </label>
                        <input type="text" class="form-control" id="ubicacion" placeholder="Ubicación de la estación">
                    </div>
                    
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="activa" checked>
                            <label class="custom-control-label" for="activa">
                                <i class="fas fa-check-circle"></i> Estación Activa
                            </label>
                        </div>
                    </div>
                    
                    <!-- Campo oculto para manejar Enter -->
                    <input type="submit" style="display: none;" id="submitForm">
                </form>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="btnCancelar">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnGuardar">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Función para obtener headers con token de autenticación
function getHeaders() {
    const token = localStorage.getItem('token');
    return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    };
}

    // Función para mostrar notificaciones con AdminLTE/Bootstrap
    function mostrarNotificacion(titulo, mensaje, tipo = 'info') {
        // Mapear tipos a clases de Bootstrap
        const tipoMap = {
            'success': 'success',
            'error': 'danger',
            'warning': 'warning',
            'info': 'info'
        };
        
        const clase = tipoMap[tipo] || 'info';
        const icono = {
            'success': 'fas fa-check-circle',
            'error': 'fas fa-exclamation-triangle',
            'warning': 'fas fa-exclamation-triangle',
            'info': 'fas fa-info-circle'
        }[tipo] || 'fas fa-info-circle';
        
        // Crear alerta de Bootstrap
        const alerta = $(`
            <div class="alert alert-${clase} fade show" role="alert">
                <h5 class="alert-heading">
                    <i class="${icono}"></i> ${titulo}
                </h5>
                <p class="mb-0">${mensaje}</p>
            </div>
        `);
        
        // Insertar al inicio del contenido principal
        $('#estaciones-content').prepend(alerta);
        
        // Auto-ocultar después de 5 segundos
        setTimeout(() => {
            alerta.fadeOut(500, function() {
                $(this).remove();
            });
        }, 5000);
        
        // Scroll suave hacia arriba para mostrar la alerta
        $('html, body').animate({
            scrollTop: $('#estaciones-content').offset().top - 20
        }, 300);
    }

    // Función para confirmación de eliminación con Bootstrap Modal
    function confirmarEliminacion(mensaje) {
        return new Promise((resolve) => {
            // Crear modal de confirmación
            const modalConfirmacion = $(`
                <div class="modal fade" id="modalConfirmacion" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header bg-warning">
                                <h5 class="modal-title">
                                    <i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación
                                </h5>
                                <button type="button" class="btn-close-custom" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <p>${mensaje}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">
                                    <i class="fas fa-trash"></i> Sí, eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
            // Agregar al body
            $('body').append(modalConfirmacion);
            
            // Crear instancia del modal
            const modal = new bootstrap.Modal(document.getElementById('modalConfirmacion'));
            
            // Manejar confirmación
            $('#btnConfirmarEliminar').on('click', function() {
                modal.hide();
                resolve(true);
            });
            
            // Manejar cancelación
            $('#modalConfirmacion').on('hidden.bs.modal', function() {
                resolve(false);
                $(this).remove();
            });
            
            // Mostrar modal
            modal.show();
        });
    }

    // Función para mostrar loading en botones
    function mostrarLoading(boton, textoOriginal) {
        boton.prop('disabled', true);
        boton.html(`<i class="fas fa-spinner fa-spin"></i> ${textoOriginal}...`);
    }

    // Función para restaurar botón después del loading
    function restaurarBoton(boton, textoOriginal) {
        boton.prop('disabled', false);
        boton.html(textoOriginal);
    }

// Función para validar el formulario
function validarFormulario() {
    const nombre = $('#nombre').val().trim();
    const codigo = $('#codigo').val().trim();
    
    let esValido = true;
    
    // Limpiar estados de validación previos
    $('#nombre, #codigo').removeClass('is-invalid');
    
    if (!nombre) {
        $('#nombre').addClass('is-invalid');
        esValido = false;
    }
    
    if (!codigo || codigo.length !== 3) {
        $('#codigo').addClass('is-invalid');
        esValido = false;
    }
    
    return esValido;
}

// Función para inicializar la página de estaciones
function inicializarEstaciones() {
    let tablaEstaciones;
    let estacionModal;

    // Inicializar el modal de AdminLTE
    estacionModal = new bootstrap.Modal(document.getElementById('estacionModal'), {
        backdrop: 'static',
        keyboard: false
    });

    // Manejar el cierre del modal
    document.getElementById('estacionModal').addEventListener('hidden.bs.modal', function () {
        // Limpiar formulario al cerrar
        $('#estacionForm')[0].reset();
        $('#nombre, #codigo').removeClass('is-invalid');
        document.body.classList.remove('modal-open');
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
    });

    // Inicializar DataTable
    tablaEstaciones = $('#tablaEstaciones').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '/api/estaciones/paginated',
            headers: getHeaders()
        },
        language: {
            url: '/datatable_lang/es-ES.json'
        },
        columns: [
            { data: 'id' },
            { data: 'nombre' },
            { data: 'codigo' },
            { data: 'ubicacion' },
            { 
                data: 'activa',
                render: function(data) {
                    return data ? 
                        '<span class="estacion-activa"><i class="fas fa-check-circle"></i> Activa</span>' : 
                        '<span class="estacion-inactiva"><i class="fas fa-times-circle"></i> Inactiva</span>';
                }
            },
            {
                data: null,
                className: 'acciones-cell',
                render: function(data) {
                    return `
                        <button class="btn btn-icon btn-editar editar-estacion" 
                                data-id="${data.id}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Editar estación">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-icon btn-eliminar eliminar-estacion" 
                                data-id="${data.id}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Eliminar estación">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                }
            }
        ],
        drawCallback: function() {
            // Reinicializar tooltips después de cada redibujado de la tabla
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
    });

    // Manejar clic en nueva estación
    $(document).on('click', '.nueva-estacion', function() {   
        $('#modalTitle').html('<i class="fas fa-plus"></i> Nueva Estación');
        $('#estacionForm')[0].reset();
        $('#estacionId').val('');
        $('#nombre, #codigo').removeClass('is-invalid');
        $('#activa').prop('checked', true);
        
        estacionModal.show();
        
        // Auto-focus en el primer campo después de que el modal se muestre
        setTimeout(() => {
            $('#nombre').focus();
        }, 300);
    });

    // Manejar clic en editar
    $(document).on('click', '.editar-estacion', function() {
        const id = $(this).data('id');
        const estacion = tablaEstaciones.row($(this).closest('tr')).data();
        
        $('#modalTitle').html('<i class="fas fa-edit"></i> Editar Estación');
        $('#estacionId').val(estacion.id);
        $('#nombre').val(estacion.nombre);
        $('#codigo').val(estacion.codigo);
        $('#ubicacion').val(estacion.ubicacion);
        $('#activa').prop('checked', estacion.activa);
        $('#nombre, #codigo').removeClass('is-invalid');
        
        estacionModal.show();
        
        // Auto-focus en el primer campo después de que el modal se muestre
        setTimeout(() => {
            $('#nombre').focus();
        }, 300);
    });

    // Manejar clic en eliminar
    $(document).on('click', '.eliminar-estacion', function() {
        const id = $(this).data('id');
        const boton = $(this);
        const textoOriginal = boton.html();
        
        confirmarEliminacion('¿Estás seguro de que deseas eliminar esta estación?')
        .then((confirmado) => {
            if (confirmado) {
                mostrarLoading(boton, 'Eliminando');
                
                fetch(`/api/estaciones/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                })
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = '/index.html';
                        return;
                    }
                    if (response.ok) {
                        mostrarNotificacion('Éxito', 'Estación eliminada correctamente', 'success');
                        tablaEstaciones.ajax.reload();
                    } else {
                        throw new Error('Error al eliminar la estación');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarNotificacion('Error', 'Error al eliminar la estación', 'error');
                })
                .finally(() => {
                    restaurarBoton(boton, textoOriginal);
                });
            }
        });
    });

    // Manejar clic en cancelar
    $(document).on('click', '#btnCancelar', function() {
        estacionModal.hide();
    });

    // Manejar clic en el botón de cierre (X)
    $(document).on('click', '#btnCerrarModal', function() {
        estacionModal.hide();
    });

    // Manejar Enter en el formulario
    $(document).on('keypress', '#estacionForm input', function(e) {
        if (e.which === 13) { // Enter key
            e.preventDefault();
            $('#btnGuardar').click();
        }
    });

    // Manejar guardar estación
    $(document).on('click', '#btnGuardar', function() {
        if (!validarFormulario()) {
            mostrarNotificacion('Error', 'Por favor corrige los errores en el formulario', 'error');
            return;
        }
        
        const boton = $(this);
        const textoOriginal = boton.html();
        mostrarLoading(boton, 'Guardando');
        
        const estacionId = $('#estacionId').val();
        const estacion = {
            nombre: $('#nombre').val().trim(),
            codigo: $('#codigo').val().trim().toUpperCase(),
            ubicacion: $('#ubicacion').val().trim(),
            activa: $('#activa').is(':checked')
        };

        const method = estacionId ? 'PUT' : 'POST';
        const url = estacionId ? `/api/estaciones/${estacionId}` : '/api/estaciones';

        fetch(url, {
            method: method,
            headers: getHeaders(),
            body: JSON.stringify(estacion)
        })
        .then(response => {
            if (response.status === 401) {
                window.location.href = '/index.html';
                return;
            }
            if (response.ok) {
                estacionModal.hide();
                mostrarNotificacion('Éxito', 'Estación guardada correctamente', 'success');
                tablaEstaciones.ajax.reload();
            } else {
                throw new Error('Error al guardar la estación');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarNotificacion('Error', 'Error al guardar la estación', 'error');
        })
        .finally(() => {
            restaurarBoton(boton, textoOriginal);
        });
    });
}

// Inicializar cuando el documento esté listo
$(document).ready(function() {
    inicializarEstaciones();
});

// Inicializar cuando se carga el contenido dinámicamente
$(document).on('contentLoaded', function() {
    inicializarEstaciones();
});
</script>
