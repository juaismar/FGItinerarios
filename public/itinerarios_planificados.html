<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Itinerarios</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .table-container {
            padding: 20px;
        }
        .header-container {
            background-color: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .btn-action {
            margin-right: 5px;
        }
        
        /* Estilos para botones de acción */
        .btn-editar {
            background-color: #17a2b8;
            color: white;
            border: none;
        }
        
        .btn-editar:hover {
            background-color: #138496;
            color: white;
        }
        
        .btn-eliminar {
            background-color: #dc3545;
            color: white;
            border: none;
        }
        
        .btn-eliminar:hover {
            background-color: #c82333;
            color: white;
        }
        
        .btn-icon {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.25rem;
            transition: all 0.15s ease-in-out;
        }
        
        .btn-icon:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Estilos para el indicador de fecha */
        #fechaMostrada {
            color: #1976d2;
            font-weight: 600;
        }
        
        .text-muted i {
            margin-right: 5px;
        }
        
        /* Estilos para el modal custom */
        #modalItinerarioCustom .modal-dialog {
            max-width: 800px;
        }
        
        #modalItinerarioCustom .form-label {
            font-weight: 600;
            color: #495057;
        }
        
        #modalItinerarioCustom .alert-info {
            background-color: #e3f2fd;
            border-color: #90caf9;
            color: #1565c0;
        }
        
        #modalItinerarioCustom .btn:disabled {
            opacity: 0.7;
        }
        
        /* Animación para el spinner */
        .fa-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilos para las filas expandibles */
        .details-row {
            background-color: #f8f9fa;
            padding: 15px;
            border-top: 1px solid #dee2e6;
        }

        .details-table {
            width: 100%;
            margin-top: 10px;
        }

        .details-table th {
            background-color: #e9ecef;
            font-weight: 600;
            padding: 8px;
            border: 1px solid #dee2e6;
        }

        .details-table td {
            padding: 8px;
            border: 1px solid #dee2e6;
        }

        .expand-button {
            cursor: pointer;
            color: #007bff;
            font-weight: bold;
        }

        .expand-button:hover {
            color: #0056b3;
        }

        .loading-details {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>Gestión de Itinerarios Planificados</h2>
                <p class="text-muted mb-0">
                    <i class="fas fa-calendar-alt text-primary"></i> 
                    Mostrando itinerarios del: <strong id="fechaMostrada"></strong>
                </p>
            </div>
            <button class="btn btn-primary">
                <i class="fas fa-plus"></i> Nuevo tren custom
            </button>
        </div>

        <!-- Tabla de Itinerarios-->
        <div class="card">
            <div class="card-body">
                <table id="tablaItinerarios" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Número</th>
                            <th>Origen</th>
                            <th>Destino</th>
                            <th>Hora</th>
                            <th>Estado</th>
                            <th>Tipo</th>
                            <th>Material</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Se llenará dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para nuevo itinerario custom -->
    <div class="modal fade" id="modalItinerarioCustom" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle text-primary"></i> Nuevo Tren Custom
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formItinerarioCustom">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Número de Tren *</label>
                                    <input type="text" class="form-control" id="numeroCustom" required 
                                           placeholder="Ej: 12345">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tipo de Tren *</label>
                                    <select class="form-select" id="tipoCustom" required>
                                        <option value="PASAJEROS" selected>Pasajeros</option>
                                        <option value="OTRO">Otro</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Origen *</label>
                                    <input type="text" class="form-control" id="origenCustom" required 
                                           placeholder="Ej: Racó">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Destino *</label>
                                    <input type="text" class="form-control" id="destinoCustom" required 
                                           placeholder="Ej: Granja">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Material Rodante</label>
                                    <input type="text" class="form-control" id="materialCustom" 
                                           placeholder="Ej: 101">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Hora de Salida *</label>
                                    <input type="time" class="form-control" id="horaSalidaCustom" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Observaciones</label>
                            <textarea class="form-control" id="observacionesCustom" rows="3" 
                                      placeholder="Observaciones adicionales sobre el itinerario..."></textarea>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Nota:</strong> Este itinerario se creará para la fecha seleccionada en el planificador: 
                            <strong id="fechaSeleccionadaModal"></strong>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="btnGuardarCustom">
                        <i class="fas fa-save"></i> Crear Itinerario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script>
        $(document).ready(function() {
            let tablaItinerarios;
            let fechaSeleccionada = window.fechaPlanificador || new Date();
            
            // Inicializar DataTable
            tablaItinerarios = $('#tablaItinerarios').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '/api/itinerariosSeleccionados/paginated',
                    headers: {
                        'Authorization': getAuthToken()
                    },
                    data: function(dtParms) {
                        // Agregar la fecha seleccionada a los parámetros
                        const fechaFormateada = fechaSeleccionada.toISOString().split('T')[0];
                        
                        // Crear fecha de inicio (00:00:00) y fin (23:59:59) del día
                        const fechaInicio = fechaFormateada + ' 00:00:00';
                        const fechaFin = fechaFormateada + ' 23:59:59';
                        
                        dtParms.cs_DateStart = fechaInicio;
                        dtParms.cs_DateEnd = fechaFin;
                    
                        return dtParms;
                    }
                },
                language: {
                    url: '/datatable_lang/es-ES.json'
                },
                columns: [
                    {
                        className: 'details-control',
                        orderable: false,
                        data: 'id',
                        defaultContent: '',
                        render: function () {
                            return '<i class="fas fa-plus-circle expand-button"></i>';
                        }
                    },
                    { data: 'numero' },
                    { data: 'origen' },
                    { data: 'destino' },
                    { 
                        data: 'fecha',
                        render: function(data) {
                            const fecha = new Date(data);
                            return fecha.toLocaleTimeString('es-ES', {
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    },
                    { 
                        data: 'estado',
                        render: function(data) {
                            const estados = {
                                'PENDIENTE': '<span class="badge bg-warning">Pendiente</span>',
                                'EN_PROGRESO': '<span class="badge bg-info">En Progreso</span>',
                                'COMPLETADO': '<span class="badge bg-success">Completado</span>',
                                'CANCELADO': '<span class="badge bg-danger">Cancelado</span>'
                            };
                            return estados[data] || data;
                        }
                    },
                    { data: 'tipo' },
                    { data: 'material' },
                    {
                        data: null,
                        className: 'acciones-cell',
                        render: function(data) {
                            return `
                                <button class="btn btn-icon btn-editar editar-itinerario" 
                                        data-id="${data.id}"
                                        data-bs-toggle="tooltip"
                                        data-bs-placement="top"
                                        title="Editar itinerario">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-icon btn-eliminar eliminar-itinerario" 
                                        data-id="${data.id}"
                                        data-bs-toggle="tooltip"
                                        data-bs-placement="top"
                                        title="Eliminar itinerario">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                        }
                    }
                ],
                order: [[4, 'asc']], // Ordenar por fecha/hora (columna 4) ascendente
                drawCallback: function() {
                    // Reinicializar tooltips después de cada redibujado de la tabla
                    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl);
                    });
                }
            });

            // Función para actualizar el indicador de fecha
            function actualizarIndicadorFecha() {
                const fechaFormateada = fechaSeleccionada.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                $('#fechaMostrada').text(fechaFormateada);
            }

            // Event listener para cambios en la fecha del planificador
            $(document).on('fechaPlanificadorCambiada', function(event, nuevaFecha) {
                fechaSeleccionada = nuevaFecha;
                // Actualizar el indicador de fecha
                actualizarIndicadorFecha();
                // Recargar la tabla con la nueva fecha
                tablaItinerarios.ajax.reload();
            });

            // Función para cargar estaciones de un itinerario
            function cargarEstacionesItinerario(itinerarioId) {
                return fetch(`/api/itinerariosSeleccionados/${itinerarioId}/estaciones`, {
                    headers: {
                        'Authorization': getAuthToken()
                    }
                })
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = '/index.html';
                        return;
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('Error al cargar estaciones del itinerario:', error);
                    throw error;
                });
            }

            // Función para formatear hora
            function formatearHora(hora) {
                if (!hora) return '-';
                return hora;
            }

            // Actualizar el indicador de fecha al inicializar
            actualizarIndicadorFecha();

            // Botón nuevo itinerario custom
            $('.btn-primary').click(function() {
                if ($(this).text().includes('Nuevo tren custom')) {
                    abrirModalItinerarioCustom();
                }
            });

            // Función para abrir modal de itinerario custom
            function abrirModalItinerarioCustom() {
                // Limpiar formulario
                $('#formItinerarioCustom')[0].reset();
                
                // Mostrar fecha seleccionada en el modal
                const fechaFormateada = fechaSeleccionada.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                $('#fechaSeleccionadaModal').text(fechaFormateada);
                
                // Abrir modal
                $('#modalItinerarioCustom').modal('show');
            }

            // Guardar itinerario custom
            $('#btnGuardarCustom').click(function() {
                if (!validarFormularioCustom()) {
                    return;
                }

                const formData = {
                    numero: $('#numeroCustom').val(),
                    origen: $('#origenCustom').val(),
                    destino: $('#destinoCustom').val(),
                    tipo: $('#tipoCustom').val(),
                    material: $('#materialCustom').val() || null,
                    observaciones: $('#observacionesCustom').val() || null,
                    fecha: crearFechaCompleta(),
                    estado: 'PENDIENTE'
                };

                crearItinerarioCustom(formData);
            });

            // Función para validar formulario
            function validarFormularioCustom() {
                const numero = $('#numeroCustom').val().trim();
                const origen = $('#origenCustom').val().trim();
                const destino = $('#destinoCustom').val().trim();
                const tipo = $('#tipoCustom').val();
                const hora = $('#horaSalidaCustom').val();

                if (!numero) {
                    alert('Por favor ingresa el número de tren');
                    $('#numeroCustom').focus();
                    return false;
                }

                if (!origen) {
                    alert('Por favor ingresa el origen');
                    $('#origenCustom').focus();
                    return false;
                }

                if (!destino) {
                    alert('Por favor ingresa el destino');
                    $('#destinoCustom').focus();
                    return false;
                }

                if (!tipo) {
                    alert('Por favor selecciona el tipo de tren');
                    $('#tipoCustom').focus();
                    return false;
                }

                if (!hora) {
                    alert('Por favor ingresa la hora de salida');
                    $('#horaSalidaCustom').focus();
                    return false;
                }

                return true;
            }

            // Función para crear fecha completa
            function crearFechaCompleta() {
                const fechaFormateada = fechaSeleccionada.toISOString().split('T')[0];
                const hora = $('#horaSalidaCustom').val();
                return `${fechaFormateada}T${hora}:00`;
            }

            // Función para crear itinerario custom
            function crearItinerarioCustom(formData) {
                $('#btnGuardarCustom').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Creando...');

                fetch('/api/itinerariosSeleccionados/custom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthToken()
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = '/index.html';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data) {
                        $('#modalItinerarioCustom').modal('hide');
                        alert('¡Itinerario custom creado exitosamente!');
                        tablaItinerarios.ajax.reload();
                    }
                })
                .catch(error => {
                    console.error('Error al crear itinerario custom:', error);
                    alert('Error al crear el itinerario custom. Por favor, inténtalo de nuevo.');
                })
                .finally(() => {
                    $('#btnGuardarCustom').prop('disabled', false).html('<i class="fas fa-save"></i> Crear Itinerario');
                });
            }
        });

                    // Manejar clic en expandir/contraer fila
            $('#tablaItinerarios tbody').on('click', 'td.details-control', function () {
                const tr = $(this).closest('tr');
                const row = tablaItinerarios.row(tr);
                const data = row.data();
                
                if (!data) {
                    console.error('No se pudo obtener los datos de la fila');
                    return;
                }
                
                const itinerarioId = data.id;

                if (row.child.isShown()) {
                    // Esta fila ya está abierta - cerrarla
                    row.child.hide();
                    tr.removeClass('shown');
                    $(this).find('i').removeClass('fa-minus-circle').addClass('fa-plus-circle');
                } else {
                    // Abrir esta fila
                    const childRow = $('<div class="loading-details">Cargando estaciones...</div>');
                    row.child(childRow).show();
                    tr.addClass('shown');
                    $(this).find('i').removeClass('fa-plus-circle').addClass('fa-minus-circle');

                    // Cargar las estaciones del itinerario
                    cargarEstacionesItinerario(itinerarioId)
                        .then(estaciones => {
                            if (estaciones.length === 0) {
                                childRow.html('<div class="text-muted">No hay estaciones asignadas a este itinerario.</div>');
                            } else {
                                let estacionesHtml = `
                                    <div class="details-row">
                                        <h6><i class="fas fa-route"></i> Estaciones del Itinerario</h6>
                                        <table class="details-table table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Orden</th>
                                                    <th>Estación</th>
                                                    <th>Código</th>
                                                    <th>Llegada Programada</th>
                                                    <th>Salida Programada</th>
                                                    <th>Observaciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                `;

                                estaciones.forEach(estacion => {
                                    estacionesHtml += `
                                        <tr>
                                            <td>${estacion.orden}</td>
                                            <td>${estacion.nombre}</td>
                                            <td>${estacion.codigo}</td>
                                            <td>${formatearHora(estacion.horaProgramadaLlegada)}</td>
                                            <td>${formatearHora(estacion.horaProgramadaSalida)}</td>
                                            <td>${estacion.observaciones || '-'}</td>
                                        </tr>
                                    `;
                                });

                                estacionesHtml += `
                                            </tbody>
                                        </table>
                                    </div>
                                `;

                                childRow.html(estacionesHtml);
                            }
                        })
                        .catch(error => {
                            childRow.html('<div class="text-danger">Error al cargar las estaciones.</div>');
                        });
                }
            });

            // Event listener para eliminar itinerario
            $(document).on('click', '.eliminar-itinerario', function() {
            const id = $(this).data('id');
            const row = $(this).closest('tr');
            const numero = row.find('td:eq(0)').text();
            const origen = row.find('td:eq(1)').text();
            const destino = row.find('td:eq(2)').text();
            const hora = row.find('td:eq(3)').text();
            
            const mensaje = `¿Estás seguro de que deseas eliminar el itinerario?\n\n` +
                           `Esta acción no se puede deshacer.`;
            
            if (confirm(mensaje)) {
                eliminarItinerario(id);
            }
        });

        // Función para eliminar itinerario
        function eliminarItinerario(id) {
            // Deshabilitar el botón durante la eliminación
            const btnEliminar = $(`.eliminar-itinerario[data-id="${id}"]`);
            const originalHtml = btnEliminar.html();
            btnEliminar.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
            
            fetch(`/api/itinerariosSeleccionados/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': getAuthToken()
                }
            })
            .then(response => {
                if (response.status === 401) {
                    window.location.href = '/index.html';
                    return;
                }
                if (response.status === 404) {
                    alert('El itinerario no fue encontrado.');
                    return;
                }
                if (response.status === 200) {
                    tablaItinerarios.ajax.reload();
                } else {
                    throw new Error('Error al eliminar el itinerario');
                }
            })
            .catch(error => {
                console.error('Error al eliminar itinerario:', error);
                alert('Error al eliminar el itinerario. Por favor, inténtalo de nuevo.');
            })
            .finally(() => {
                // Restaurar el botón
                btnEliminar.prop('disabled', false).html(originalHtml);
            });
        }

        // Función para editar itinerario (placeholder para futura implementación)
        function editarItinerario(id) {
            // Aquí iría la lógica para cargar y editar el itinerario
            alert('Función de edición en desarrollo');
        }
    </script>
</body>
</html> 