<style>
    .table-container {
        padding: 20px;
    }

    .header-container {
        background-color: #f8f9fa;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 5px;
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <h2 class="me-3">Control de Estación</h2>
            <div class="d-flex align-items-center">
                <label for="estacionSelector" class="form-label me-2 mb-0">
                    <i class="fas fa-map-marker-alt text-primary"></i> Estación:
                </label>
                <select class="form-select" id="estacionSelector" style="width: 250px;">
                    <option value="">Seleccionar estación</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Tabla de llegadas-->
    <div class="card">
        Llegadas
        <div class="card-body">
            <table id="tablaLlegadas" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Número</th>
                        <th>Origen</th>
                        <th>Destino</th>
                        <th>Hora</th>
                        <th>Estado</th>
                        <th>Tipo</th>
                        <th>Material</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Se llenará dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        let tablaLlegadas;
        let fechaSeleccionada = window.fechaPlanificador || new Date();
        let estaciones;
        cargarEstaciones();
        // Función para cargar estaciones desde la API
        function cargarEstaciones() {
            return fetch('/api/estaciones', {
                headers: getHeaders()
            })
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = '/index.html';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    // Guardar las estaciones en la variable global
                    estaciones = data;
                    cargarEstacionesEnSelect();
                })
                .catch(error => {
                    console.error('Error al cargar estaciones:', error);
                    alert('Error al cargar las estaciones');
                });
        }

        // Función para formatear fecha ignorando timezone (hora local)
        function formatearFechaLocal(fecha) {
            return fecha.getFullYear() + '-' + 
                String(fecha.getMonth() + 1).padStart(2, '0') + '-' + 
                String(fecha.getDate()).padStart(2, '0') + ' ' + 
                String(fecha.getHours()).padStart(2, '0') + ':' + 
                String(fecha.getMinutes()).padStart(2, '0') + ':' + 
                String(fecha.getSeconds()).padStart(2, '0');
        }

        // Ejecutar cargarDatosLlegadas cada 10 segundos
        setInterval(cargarDatosLlegadas(), 10000);

        function cargarDatosLlegadas() {
            const fechaFormateada = fechaSeleccionada.toISOString().split('T')[0];
            const fechaInicio = fechaFormateada + ' 00:00:00';
            
                         // Calcular fecha fin como hora actual + 2 minutos
             const ahora = new Date();
             const fechaFin = new Date(ahora.getTime() + 2 * 60 * 1000); // +2 minutos
             const fechaFinFormateada = formatearFechaLocal(fechaFin);
            
            const estacionId = $('#estacionSelector').val() || 1;

            const url = `/api/controlEstacion/llegadas?cs_DateStart=${encodeURIComponent(fechaInicio)}&cs_DateEnd=${encodeURIComponent(fechaFinFormateada)}&cs_EstacionId=${estacionId}`;

            fetch(url, {
                headers: getHeaders()
            })
            .then(response => {
                console.log('response: ' + response);
                console.log(response);
                if (response.status === 401) {
                    window.location.href = '/index.html';
                    return;
                }
                return response.json();
            })
            .then(data => {
                actualizarTablaLlegadas(data);
            })
            .catch(error => {
                console.error('Error al cargar datos de llegadas:', error);
            });
        }

        function actualizarTablaLlegadas(data) {
            const tbody = document.querySelector('#tablaLlegadas tbody');
            tbody.innerHTML = '';

            if (data && data.length > 0) {
                data.forEach(item => {
                    const row = document.createElement('tr');
                    
                    const fecha = new Date(item.fecha);
                    const horaFormateada = fecha.toLocaleTimeString('es-ES', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const estados = {
                        'PENDIENTE': '<span class="badge bg-warning">Pendiente</span>',
                        'EN_PROGRESO': '<span class="badge bg-info">En Progreso</span>',
                        'COMPLETADO': '<span class="badge bg-success">Completado</span>',
                        'CANCELADO': '<span class="badge bg-danger">Cancelado</span>'
                    };

                    row.innerHTML = `
                        <td>${item.numero}</td>
                        <td>${item.origen}</td>
                        <td>${item.destino}</td>
                        <td>${horaFormateada}</td>
                        <td>${estados[item.estado] || item.estado}</td>
                        <td>${item.tipo || '-'}</td>
                        <td>${item.material || '-'}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" class="text-center">No hay datos disponibles</td>';
                tbody.appendChild(row);
            }
        }

        $('#estacionSelector').change(function () {
            const estacionId = $('#estacionSelector').val();
            cargarDatosLlegadas();
        });

        // Event listener para cambios en la fecha del planificador
        $(document).on('fechaPlanificadorCambiada', function (event, nuevaFecha) {
            fechaSeleccionada = nuevaFecha;
            // Recargar la tabla con la nueva fecha
            cargarDatosLlegadas();
        });

        // Función para cargar estaciones de un itinerario
        function cargarEstacionesItinerario(itinerarioId) {
            return fetch(`/api/itinerariosSeleccionados/${itinerarioId}/estaciones`, {
                headers: {
                    'Authorization': getAuthToken()
                }
            })
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = '/index.html';
                        return;
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('Error al cargar estaciones del itinerario:', error);
                    throw error;
                });
        }

        // Función para formatear hora
        function formatearHora(hora) {
            if (!hora) return '-';
            return hora;
        }

        // Botón nuevo itinerario custom
        $('.btn-primary').click(function () {
            if ($(this).text().includes('Nuevo tren custom')) {
                abrirModalItinerarioCustom();
            }
        });


        // Event listener para agregar estación
        $(document).on('click', '#btnAgregarEstacion', function () {
            agregarEstacionAlContenedor();
        });




        // Función para cargar estaciones en el select
        function cargarEstacionesEnSelect() {
            const select = document.getElementById('estacionSelector');
            select.innerHTML = '<option value="">Seleccionar estación</option>';

            if (estaciones) {
                estaciones.forEach(estacion => {
                    if (estacion.gestionado == true) {
                        const option = document.createElement('option');
                        option.value = estacion.id;
                        option.textContent = `${estacion.nombre} (${estacion.codigo})`;
                        select.appendChild(option);
                    }
                });
            }
        }

        // Event listener para eliminar itinerario
        $(document).on('click', '.eliminar-itinerario', function () {
            const id = $(this).data('id');
            const row = $(this).closest('tr');
            const numero = row.find('td:eq(0)').text();
            const origen = row.find('td:eq(1)').text();
            const destino = row.find('td:eq(2)').text();
            const hora = row.find('td:eq(3)').text();

            const mensaje = `¿Estás seguro de que deseas eliminar el itinerario?\n\n` +
                `Esta acción no se puede deshacer.`;

            if (confirm(mensaje)) {
                eliminarItinerario(id);
            }
        });


    });

</script>